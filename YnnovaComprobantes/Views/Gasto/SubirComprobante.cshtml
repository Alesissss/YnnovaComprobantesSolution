@model YnnovaComprobantes.ViewModels.GastoViewModel
@{
    ViewData["Title"] = "Subir comprobante";
    string tipoGasto = Model.TipoGasto;
}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="text-center mb-0">Subir comprobante</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <h3>Anticipo del <strong id="txt_FechaGasto">@Model.Fecha</strong></h3>
                            <h4>Importe asignado: <strong id="txt_Importe">@Model.MonedaSimbolo @Model.Importe</strong>
                            </h4>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="txt_RUC">RUC de la empresa</label>
                            <input type="text" id="txt_RUC" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_Serie">Serie del comprobante</label>
                            <input type="text" id="txt_Serie" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_Numero">Número del comprobante</label>
                            <input type="text" id="txt_Numero" class="form-control">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="cbx_TipoComprobante">Tipo de comprobante</label>
                            <select id="cbx_TipoComprobante" class="form-control">
                                <option value="" disabled selected>--SELECCIONAR--</option>
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="cbx_Concepto">Concepto</label>
                            <select id="cbx_Concepto" class="form-control">
                                <option value="" disabled selected>--SELECCIONAR--</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Moneda">Moneda</label>
                            <select id="cbx_Moneda" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_Monto">Monto</label>
                            <input type="number" id="txt_Monto" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="txt_Fecha">Fecha</label>
                            <input type="date" id="txt_Fecha" class="form-control">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="txt_Descripcion">Descripción</label>
                            <textarea id="txt_Descripcion" class="form-control" rows="4"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="file_Imagen">Archivo de Comprobante (Imagen, PDF)</label>

                            <div id="dropZone" class="drop-zone text-center p-4 border rounded"
                                style="border-style: dashed!important; cursor: pointer;">
                                <p class="text-muted mb-2">Arrastra tu archivo aquí o haz clic para subir</p>
                                <div id="uploadArea" class="col-12 text-center">
                                    <label class="btn btn-warning {% if btnId == 'btn_Aceptar' %}disabled{% endif %}"
                                        for="file_Imagen">
                                        <i class="fas fa-upload"></i> Subir archivo
                                    </label>
                                </div>
                                <div id="previewArea" class="mt-3" style="display: none;">
                                    <span id="fileNameDisplay" class="d-block mb-2 font-weight-bold"></span>
                                    <img id="imagePreview" class="img-thumbnail"
                                        style="max-width: 150px; display: none;">
                                    <i id="pdfIcon" class="fas fa-file-pdf fa-3x text-danger"
                                        style="display: none;"></i>
                                    <span id="checkIcon" class="text-success d-block mt-2">
                                        <i class="fas fa-check-circle"></i> Archivo listo para enviar
                                    </span>
                                    <button type="button" id="removeFileButton" class="btn btn-sm btn-danger mt-2">
                                        <i class="fas fa-trash-alt"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-12 mb-3">
                                <input type="file" class="d-none" id="file_Archivos" accept=".jpg, .jpeg, .png, .pdf">
                                <input type="file" class="d-none" id="file_Camara" accept="image/*" capture="camera">
                            </div>
                        </div>
                        <div class="col-md-12 text-center">
                            <button id="btn_Volver" type="button" class="btn btn-danger">Volver</button>
                            <button id="btn_Registrar" type="button" class="btn btn-primary">Registrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {

        // 1. Validación de RUC (solo dígitos y límite de 11)
            $('#txt_RUC').on('keypress', function (e) {
                // Obtenemos el código de la tecla presionada
                var charCode = (e.which) ? e.which : e.keyCode;

                // Permitir solo dígitos (48-57) y teclas de control
                if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                    e.preventDefault();
                    return false;
                }

                // Limitar la longitud a 11 dígitos (antes de que se añada el nuevo dígito)
                if ($(this).val().length >= 11) {
                    // Si es un dígito, prevenir la entrada
                    if (charCode > 47 && charCode < 58) {
                        e.preventDefault();
                    return false;
                }
            }
        });

            $('#txt_Serie').on('keypress', function (e) {
                if ($(this).val().length >= 4) {
                    e.preventDefault();
                    return false;
                }
            });

            $('#txt_Numero').on('keypress', function (e) {
                var charCode = (e.which) ? e.which : e.keyCode;

                // Permitir solo dígitos (48-57) y teclas de control
                if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                    e.preventDefault();
                    return false;
                }
            });

        function inicializarRellenoConDesplazamiento() {
            if (typeof jQuery === 'undefined') {
                console.error("jQuery no está cargado.");
                return;
            }

            $(document).ready(function() {
                const $input = $('#txt_Numero');
                const MAX_LENGTH = 10;

                let currentValue = ''.padStart(MAX_LENGTH, '0');

                function formatValue(value) {
                    let filteredValue = String(value).replace(/[^0-9]/g, '');

                    if (filteredValue.length < MAX_LENGTH) {
                        return filteredValue.padStart(MAX_LENGTH, '0');
                    }
                    return filteredValue.substring(filteredValue.length - MAX_LENGTH);
                }

                $input.val(formatValue($input.val() || ''));
                currentValue = $input.val();

                $input.on('focus', function() {
                     if ($(this).val() === ''.padStart(MAX_LENGTH, '0')) {
                     }
                });

                $input.on('input', function() {
                    let newValue = $(this).val();

                    let filteredValue = newValue.replace(/[^0-9]/g, '');

                    if (!filteredValue || filteredValue === currentValue) {
                        return;
                    }

                    if (filteredValue.length > currentValue.length) {
                        let newChar = filteredValue.substring(filteredValue.length - 1);

                        currentValue = currentValue.substring(1) + newChar;

                    } else if (filteredValue.length < currentValue.length) {
                         currentValue = '0' + filteredValue;
                    } else {
                         currentValue = filteredValue;
                    }

                    $(this).val(formatValue(currentValue));

                    if (filteredValue.length > currentValue.length) {
                         const inputElement = this;
                         inputElement.setSelectionRange(MAX_LENGTH, MAX_LENGTH);
                    }
                });

                $input.on('blur', function() {
                    currentValue = formatValue($(this).val());
                    $(this).val(currentValue);
                });
            });
        }

        inicializarRellenoConDesplazamiento();
        fct_IngresarImagen();
        fct_GetMonedas();
        fct_GetTipoComprobante();
        fct_GetConceptos();

        function fct_GetMonedas() {
            $.getJSON('/Gasto/GetMonedasData', function (response) {
                if (response.status === true) {
                    let items = '<option disabled selected>--SELECCIONAR--</option>';

                    $.each(response.data, function (index, item) {
                        items += `<option value="${item.id}">${item.simbolo} ${item.nombre}</option>`;
                    });

                    $('#cbx_Moneda').html(items);
                } else {
                    toastr.error('Ocurrió un error al listar a las monedas', 'MENSAJE DE SISTEMA');
                    console.error('Error', response.message);
                }
            });
        }

        function fct_GetTipoComprobante() {
            $.getJSON('/Gasto/GetTipoComprobanteData', function (response) {
                if (response.status === true) {
                    let tiposComprobantes = response.data;
                    var dataTC = tiposComprobantes.map(function(tc) {
                        return {
                            id: tc.id,
                            text: tc.codigo + ' - ' + tc.descripcion,
                        }
                    });

                    $('#cbx_TipoComprobante').empty().select2({
                        theme: 'bootstrap4',
                        data: dataTC,
                        placeholder: 'Buscar tipo de comprobante...',
                        allowClear: true,
                        language: {
                            noResults: function () {
                                return "No se encontraron resultados";
                            }
                        }
                    });

                    $('#cbx_TipoComprobante').val(null).trigger('change');
                } else {
                    toastr.error('Ocurrió un error al listar a los tipos de comprobantes.', 'MENSAJE DE SISTEMA');
                    console.error('Error', response.message);
                }
            });
        }

        function fct_GetConceptos() {
            $.getJSON('/Gasto/GetConceptoData', function (response) {
                if (response.status === true) {
                    let conceptos = response.data;
                    var dataConcepto = conceptos.map(function(concepto) {
                        return {
                            id: concepto.id,
                            text: concepto.nombre,
                        }
                    });

                    $('#cbx_Concepto').empty().select2({
                        theme: 'bootstrap4',
                        data: dataConcepto,
                        placeholder: 'Buscar concepto...',
                        allowClear: true,
                        language: {
                            noResults: function () {
                                return "No se encontraron resultados";
                            }
                        }
                    });

                    $('#cbx_Concepto').val(null).trigger('change');
                } else {
                    toastr.error('Ocurrió un error al listar a los conceptos.', 'MENSAJE DE SISTEMA');
                    console.error('Error', response.message);
                }
            });
        }

        $("#btn_Registrar").click(function () {
            let tipoGasto = '@Model.TipoGasto';

            if (!tipoGasto) {
                toastr.warning('No existe el tipo de gasto.', 'MENSAJE DE SISTEMA');
                return;
            }

            if (tipoGasto === "ANTICIPO") {
                let ruc = $('#txt_RUC').val();
                let serie = $('#txt_Serie').val();
                let numero = $('#txt_Numero').val();
                let tipoComprobante = $('#cbx_TipoComprobante').val();
                let concepto = $('#cbx_Concepto').val();
                let moneda = $('#cbx_Moneda').val();
                let monto = $('#txt_Monto').val();
                let fecha = $('#txt_Fecha').val();
                let descripcion = $('#txt_Descripcion').val();

                let archivoParaSubir = null;
                const inputArchivos = document.getElementById('file_Archivos');
                const inputCamara = document.getElementById('file_Camara');

                // Revisar si el usuario seleccionó un archivo tradicional
                if (inputArchivos.files && inputArchivos.files.length > 0) {
                    archivoParaSubir = inputArchivos.files[0];
    
                } 
                // O revisar si el usuario tomó una foto con la cámara
                else if (inputCamara.files && inputCamara.files.length > 0) {
                    archivoParaSubir = inputCamara.files[0];
                }
                

                if (!ruc || !serie || !numero || !tipoComprobante || !concepto || !moneda || !monto || !fecha || !archivoParaSubir) {
                    toastr.warning("Todos los campos son obligatorios", "MENSAJE DE SISTEMA");
                    return;
                }

                Swal.fire({
                    title: "¿Estás seguro?",
                    text: "Esta acción registrará al comprobante. ¿Deseas continuar?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, registrar comprobante",
                    cancelButtonText: "Cancelar",
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {

                        let formData = new FormData();
                        formData.append("RucEmpresa", ruc);
                        formData.append("Serie", serie);
                        formData.append("Numero", numero);
                        formData.append("TipoComprobanteId", tipoComprobante);
                        formData.append("ConceptoId", concepto);
                        formData.append("MonedaId", moneda);
                        formData.append("Monto", monto);
                        formData.append("Fecha", fecha);
                        formData.append("Descripcion", descripcion);
                        formData.append("UsuarioId", @Model.UsuarioId);
                        formData.append("GastoId", @Model.Id);
                        formData.append("ArchivoComprobante", archivoParaSubir);

                        $.ajax({
                            url: "/Gasto/RegistrarComprobante",
                            type: "POST",
                            processData: false,
                            contentType: false,
                            data: formData,
                            success: function (response) {
                                if (response.status === true) {
                                    toastr.success(response.message, "MENSAJE DE SISTEMA");
                                    window.location.href = "/Gasto/MisGastos";
                                } else {
                                    toastr.warning(response.message, 'MENSAJE DE SISTEMA');
                                    return;
                                }
                            },
                            error: function (xhr, Status, error) {
                                toastr.error("Error en el servidor", "MENSAJE DE SISTEMA");
                                console.error('Error en la solicitud Ajax. Status:', Status, 'Error:', error, 'XHR:', xhr);
                            }
                        });
                    }
                });
            } else if (tipoGasto === "REEMBOLSO") {
                let empresa = $('#cbx_Empresa').val();
                let usuario = $('#cbx_Usuario').val();
                let tipoGasto = $('#cbx_TipoGasto').val();
                let fecha = $('#txt_Fecha').val();
                let descripcion = $('#txt_Descripcion').val();

                if (!empresa || !usuario || !tipoGasto || !fecha) {
                    toastr.warning("Todos los campos son obligatorios", "MENSAJE DE SISTEMA");
                    return;
                }

                Swal.fire({
                    title: "¿Estás seguro?",
                    text: "Esta acción registrará al reembolso. ¿Deseas continuar?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, registrar reembolso",
                    cancelButtonText: "Cancelar",
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {

                        let formData = new FormData();
                        formData.append("Fecha", fecha);
                        formData.append("Descripcion", descripcion);
                        formData.append("EmpresaId", empresa);
                        formData.append("UsuarioId", usuario);
                        formData.append("TipoGastoId", tipoGasto);

                        $.ajax({
                            url: "/Gasto/RegistrarGasto",
                            type: "POST",
                            processData: false,
                            contentType: false,
                            data: formData,
                            success: function (response) {
                                if (response.status === true) {
                                    toastr.success(response.message, "MENSAJE DE SISTEMA");
                                    window.location.href = "/Gasto";
                                } else {
                                    toastr.warning(response.message, 'MENSAJE DE SISTEMA');
                                    return;
                                }
                            },
                            error: function (xhr, Status, error) {
                                toastr.error("Error en el servidor", "MENSAJE DE SISTEMA");
                                console.error('Error en la solicitud Ajax. Status:', Status, 'Error:', error, 'XHR:', xhr);
                            }
                        });
                    }
                });
            }
        });

        function fct_IngresarImagen() {
            const dropZone = $('#dropZone');
            const fileInputArchivos = $('#file_Archivos');
            const fileInputCamara = $('#file_Camara');
            const uploadButtonLabel = $('#uploadArea label');
            const previewArea = $('#previewArea');
            const uploadArea = $('#uploadArea');
            const imagePreview = $('#imagePreview');
            const pdfIcon = $('#pdfIcon');
            const fileNameDisplay = $('#fileNameDisplay');
            const removeFileButton = $('#removeFileButton');

            uploadButtonLabel.on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (confirm("¿Cómo desea cargar el comprobante?\n\nAceptar: Abrir la cámara\nCancelar: Abrir mis archivos")) {
                    fileInputCamara.click();
                } else {
                    fileInputArchivos.click();
                }
            });

            fileInputArchivos.on('change', function() {
                if (this.files.length > 0) {
                    handleFile(this.files[0]);
                }
            });

            fileInputCamara.on('change', function() {
                if (this.files.length > 0) {
                    handleFile(this.files[0]);
                }
            });

            function handleFile(file) {
                if (file) {
                    fileNameDisplay.text(file.name);
                    previewArea.show();
                    uploadArea.hide();

                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            imagePreview.attr('src', e.target.result).show();
                            pdfIcon.hide();
                        };
                        reader.readAsDataURL(file);
                    }
                    else if (file.type === 'application/pdf') {
                        imagePreview.hide();
                        pdfIcon.show();
                    } else {
                        alert('Formato de archivo no soportado. Por favor use JPG, PNG o PDF.');
                        resetDropZone();
                        return;
                    }
                }
            }

            function resetDropZone() {
                fileInputArchivos.val('');
                previewArea.hide();
                uploadArea.show();
                imagePreview.hide().attr('src', '');
                pdfIcon.hide();
                dropZone.removeClass('drag-over');
            }


            fileInputArchivos.on('change', function () {
                if (this.files.length > 0) {
                    handleFile(this.files[0]);
                }
            });

            dropZone.on('dragover dragleave drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
            });

            dropZone.on('dragover', function () {
                $(this).addClass('drag-over');
            });

            dropZone.on('dragleave', function () {
                $(this).removeClass('drag-over');
            });

            dropZone.on('drop', function (e) {
                $(this).removeClass('drag-over');

                if (e.originalEvent.dataTransfer.files.length > 0) {
                    fileInputArchivos[0].files = e.originalEvent.dataTransfer.files;
                    handleFile(fileInputArchivos[0].files[0]);
                }
            });

            removeFileButton.on('click', resetDropZone);
        }

        $("#btn_Volver").click(function () {
            window.location.href = "/Gasto/MisGastos";
        });
    });
</script>
<style>
    .drag-over {
        background-color: #f0f8ff;
        border-color: #007bff !important;
    }
</style>