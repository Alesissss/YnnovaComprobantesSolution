@{
    ViewData["Title"] = "Auditoría de Liquidación";
    int liqId = ViewBag.LiquidacionId;
}

<input type="hidden" id="hdn_LiqId" value="@liqId">

<div class="container-fluid pt-3">

    <div class="card card-navy shadow-sm mb-3">
        <div class="card-body p-2">
            <div class="row align-items-center">
                <div class="col-md-3 border-right">
                    <h5 class="mb-0 font-weight-bold text-navy" id="lbl_Codigo"><i class="fas fa-spinner fa-spin"></i></h5>
                    <small class="text-muted d-block" id="lbl_Empresa">-</small>
                    <small class="text-muted" id="lbl_Responsable">-</small>
                </div>

                <div class="col-md-6 text-center">
                    <span class="text-muted small text-uppercase font-weight-bold mb-1 d-block">Resumen de Caja</span>
                    <div class="d-flex justify-content-center align-items-center font-weight-bold" style="font-size: 1.2rem;">
                        <div class="px-3">
                            <span class="text-success" id="lbl_Ingresos">S/ 0.00</span>
                            <br><small class="text-muted" style="font-size: 0.7rem;">INGRESOS (ANTICIPOS)</small>
                        </div>
                        <div class="text-muted">-</div>
                        <div class="px-3">
                            <span class="text-danger" id="lbl_Egresos">S/ 0.00</span>
                            <br><small class="text-muted" style="font-size: 0.7rem;">GASTOS (APROBADOS)</small>
                        </div>
                        <div class="text-muted">=</div>
                        <div class="px-3">
                            <span class="badge badge-light border" id="lbl_Saldo">S/ 0.00</span>
                            <br><small class="text-muted" style="font-size: 0.7rem;">SALDO FINAL</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 text-right border-left">
                    <div id="div_EstadoBadge" class="mb-2"></div>
                    <button id="btn_CerrarLiq" class="btn btn-danger btn-block font-weight-bold shadow-sm" onclick="fct_CerrarLiquidacion()">
                        <i class="fas fa-file-signature"></i> CERRAR CARPETA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card card-success card-outline h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title"><i class="fas fa-hand-holding-usd mr-1"></i> 1. Anticipos</h3>
                    <button class="btn btn-success btn-xs font-weight-bold btn-auditar" onclick="$('#mdl_NuevoAnticipo').modal('show')">
                        <i class="fas fa-plus"></i> Nuevo
                    </button>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-sm table-striped mb-0" id="tbl_Anticipos">
                        <thead class="bg-light">
                            <tr>
                                <th>Tipo rendición</th>
                                <th>Banco</th>
                                <th>Moneda</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th class="text-center">Voucher</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card-footer small text-muted">
                    <i class="fas fa-info-circle"></i> Registre el anticipo y luego suba el voucher para confirmarlo.
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card card-primary card-outline card-tabs h-100 shadow-sm">
                <div class="card-header p-0 pt-1 border-bottom-0">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="pill" href="#tab-facturas" role="tab">
                                <i class="fas fa-receipt mr-1"></i> 2. Comprobantes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="pill" href="#tab-planilla" role="tab">
                                <i class="fas fa-taxi mr-1"></i> 3. Planilla Movilidad
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-facturas" role="tabpanel">
                            <table class="table table-bordered table-sm w-100" id="tbl_Comprobantes">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Proveedor</th>
                                        <th>Moneda</th>
                                        <th class="text-right">Monto</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-center" style="width: 100px;">Auditar</th>
                                        <th class="text-center">Ver</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="tab-planilla" role="tabpanel">
                            <table class="table table-bordered table-sm w-100" id="tbl_Planilla">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Ruta / Motivo</th>
                                        <th class="text-right">Monto</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-center" style="width: 50px;">Acción</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-12">
            <div class="card card-warning collapsed-card shadow-sm">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-comments mr-1"></i> Observaciones / Chat</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="card-body" style="display: none;">
                    <div class="direct-chat-messages" id="div_ChatBox" style="height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa;">
                    </div>
                    <div class="input-group mt-2">
                        <input type="text" id="txt_Mensaje" placeholder="Escribir observación..." class="form-control">
                        <span class="input-group-append">
                            <button type="button" class="btn btn-warning" onclick="enviarObservacion()">Enviar</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="mdl_NuevoAnticipo" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus mr-1"></i> Asignar Anticipo</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="txt_Ant_FechaSolicitud">Fecha de Solicitud</label>
                            <input type="date" id="txt_Ant_FechaSolicitud" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_Ant_FechaLimiteRendicion">Fecha límite de rendición</label>
                            <input type="date" id="txt_Ant_FechaLimiteRendicion" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Ant_TipoRendicion">Tipo de rendición</label>
                            <select id="cbx_Ant_TipoRendicion" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Ant_Banco">Banco (Depósito)</label>
                            <select id="cbx_Ant_Banco" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Ant_Moneda">Moneda</label>
                            <select id="cbx_Ant_Moneda" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_Ant_Monto">Monto solicitado</label>
                            <input type="number" id="txt_Ant_Monto" class="form-control" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="txt_Ant_Descripcion">Descripción (opcional)</label>
                            <textarea id="txt_Ant_Descripcion" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="fct_RegistrarAnticipo()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdl_Voucher" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-navy text-white">
                <h5 class="modal-title"><i class="fas fa-money-check-alt mr-1"></i> Confirmar Transferencia</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hdn_AnticipoId_Transfer">
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle"></i> Suba la constancia de pago para confirmar el desembolso.
                </div>
                <div class="form-group">
                    <label>N° Operación Banco</label>
                    <input type="text" id="txt_Op" class="form-control" placeholder="Ej: 123456">
                </div>
                <div class="form-group">
                    <label>Fecha Transferencia</label>
                    <input type="datetime-local" id="txt_FechaTransfer" class="form-control">
                </div>
                <div class="form-group">
                    <label>Adjuntar Voucher (Imagen/PDF)</label>
                    <div id="dropZone" class="drop-zone text-center p-2 rounded bg-light">
                        <p class="text-muted mb-1 small" id="lbl_DropInfo">Arrastra o click aquí</p>
                        <input type="file" id="file_V" class="d-none" accept=".jpg, .jpeg, .png, .pdf">
                        <div id="previewArea" style="display:none;" class="d-flex align-items-center justify-content-center">
                            <i id="icon_Preview" class="fas fa-file mr-2"></i>
                            <span id="name_Preview" class="small font-weight-bold mr-2">archivo.pdf</span>
                            <button type="button" class="btn btn-xs btn-danger" id="btn_RemoveFile"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="fct_GuardarTransferencia()">Registrar Pago</button>
            </div>
        </div>
    </div>
</div>

<script>
    var liqId = $('#hdn_LiqId').val();

    $(document).ready(function () {
        cargarTodo();
        inicializarInputFile();


        let fSolicitud = new Date($('#txt_Ant_FechaSolicitud').val());
        let fLimite = new Date($('#txt_Ant_FechaLimiteRendicion').val());

        if (fLimite < fSolicitud) {
            toastr.error("La fecha límite no puede ser anterior a la fecha de solicitud", "SISTEMA");
            return;
        }

        $('#txt_Ant_FechaSolicitud').on('change', function () {
            let fechaSeleccionada = $(this).val();

            if (fechaSeleccionada) {
                let date = new Date(fechaSeleccionada);

                date.setDate(date.getDate() + 7);

                let año = date.getFullYear();
                let mes = ("0" + (date.getMonth() + 1)).slice(-2);
                let dia = ("0" + date.getDate()).slice(-2);

                let fechaLimite = `${año}-${mes}-${dia}`;

                $('#txt_Ant_FechaLimiteRendicion').val(fechaLimite);
            }
        });

        if ($('#txt_Ant_FechaSolicitud').val()) {
            $('#txt_Ant_FechaSolicitud').trigger('change');
        }
    });

    function cargarTodo() {
        cargarCabecera();
        cargarAnticipos();
        cargarComprobantes();
        cargarPlanilla();
        cargarResumen();
        cargarChat();
        fct_GetTipoRendicion();
        fct_GetBancos();
        fct_GetMonedas();
    }

        function fct_GetTipoRendicion() {
            $.getJSON('/Liquidacion/GetTiposRendicionesData', function (res) {
                if (res.status) {
                    let data = res.data.map(t => ({ id: t.id, text: t.codigo + ' - ' + t.descripcion }));
                    $('#cbx_Ant_TipoRendicion').select2({ theme: 'bootstrap4', data: data, placeholder: "Seleccionar Tipo" });
                }
            });
        }

        function fct_GetBancos() {
            $.getJSON('/Liquidacion/GetBancosData', function (res) {
                if (res.status) {
                    let data = res.data.map(b => ({ id: b.id, text: b.codigo + ' - ' + b.descripcion }));
                    $('#cbx_Ant_Banco').select2({ theme: 'bootstrap4', data: data, placeholder: "Seleccionar Banco" });
                }
            });
        }

        function fct_GetMonedas() {
            $.getJSON('/Liquidacion/GetMonedasData', function (res) {
                if (res.status) {
                    let opt = '<option value="" disabled selected>--SELECCIONAR--</option>';
                    res.data.forEach(m => opt += `<option value="${m.id}">${m.simbolo} ${m.nombre}</option>`);
                    $('#cbx_Ant_Moneda').html(opt);
                }
            });
        }

    // --- CABECERA ---
    function cargarCabecera() {
        $.getJSON('/Liquidacion/ObtenerDatosCarpeta', { liquidacionId: liqId }, function(res) {
            if(res.status) {
                $('#lbl_Codigo').text(res.data.codigoGenerado);
                $('#lbl_Empresa').text(res.data.empresa);
                $('#lbl_Responsable').html(`<i class="fas fa-user"></i> ${res.data.usuario}`);

                let badge = res.data.estado === 'Abierta'
                    ? '<span class="badge badge-success px-3">ABIERTA</span>'
                    : '<span class="badge badge-secondary px-3">CERRADA</span>';
                $('#div_EstadoBadge').html(badge);

                if(res.data.esCerrada) {
                    $('#btn_CerrarLiq').prop('disabled', true).text('LIQUIDACIÓN CERRADA');
                    $('.btn-auditar').prop('disabled', true);
                }
            }
        });
    }

    function cargarResumen() {
        $.getJSON('/Liquidacion/ObtenerResumenFinanciero', { liquidacionId: liqId }, function(res) {
            if(res.status) {
                $('#lbl_Ingresos').text("S/ " + res.ingresos.toFixed(2));
                $('#lbl_Egresos').text("S/ " + res.gastos.toFixed(2));

                let saldo = res.saldo;
                $('#lbl_Saldo').text("S/ " + Math.abs(saldo).toFixed(2));
                $('#lbl_Saldo').removeClass('badge-success badge-danger badge-light');
                $('#lbl_AccionSaldo').remove();

                if(saldo > 0) {
                    $('#lbl_Saldo').addClass('badge-success');
                    $('#lbl_Saldo').after('<br><small class="text-success font-weight-bold" id="lbl_AccionSaldo">(DEVOLUCIÓN)</small>');
                } else if (saldo < 0) {
                    $('#lbl_Saldo').addClass('badge-danger');
                    $('#lbl_Saldo').after('<br><small class="text-danger font-weight-bold" id="lbl_AccionSaldo">(REEMBOLSO)</small>');
                } else {
                    $('#lbl_Saldo').addClass('badge-light');
                    $('#lbl_Saldo').after('<br><small class="text-muted font-weight-bold" id="lbl_AccionSaldo">(CUADRADO)</small>');
                }
            }
        });
    }

    // --- ANTICIPOS ---
    function cargarAnticipos() {
        $.getJSON('/Liquidacion/ListarAnticipos', { liquidacionId: liqId }, function(res) {
            let html = '';
            res.data.forEach(a => {
                let accion = '';
                // Lógica corregida:
                // Generado = Admin lo creó, falta voucher.
                // Transferido = Admin ya subió voucher.
                if(a.estado === 'Generado') {
                    accion = `<button class="btn btn-primary btn-xs btn-block btn-auditar" onclick="abrirModalVoucher(${a.id})">
                                <i class="fas fa-upload mr-1"></i> Subir Voucher
                              </button>`;
                } else if (a.estado === 'Transferido') {
                    accion = `<a href="${a.voucherUrl}" target="_blank" class="btn btn-info btn-xs btn-block">
                                <i class="fas fa-eye mr-1"></i> Ver Voucher
                              </a>`;
                }

                html += `<tr>
                            <td class="align-middle">${a.tipoRendicion}</td>
                            <td class="align-middle">${a.banco}</td>
                            <td class="align-middle">${a.moneda}</td>
                            <td class="align-middle font-weight-bold">${a.monto.toFixed(2)}</td>
                            <td class="align-middle"><span class="badge badge-${a.estado==='Transferido'?'success':'warning'}">${a.estado}</span></td>
                            <td class="align-middle">${accion}</td>
                         </tr>`;
            });
            $('#tbl_Anticipos tbody').html(html);
        });
    }

    // NUEVO: Admin Registra Anticipo
    function fct_RegistrarAnticipo() {
         // Recolección de datos
            let obj = {
                LiquidacionId: liqId,
                FechaSolicitud: $('#txt_Ant_FechaSolicitud').val(),
                FechaLimiteRendicion: $('#txt_Ant_FechaLimiteRendicion').val(),
                TipoRendicionId: $('#cbx_Ant_TipoRendicion').val(), // FK de la tabla
                BancoId: $('#cbx_Ant_Banco').val(),
                MonedaId: $('#cbx_Ant_Moneda').val(),
                Monto: $('#txt_Ant_Monto').val(),
                Descripcion: $('#txt_Ant_Descripcion').val()
            };

            // Validación simple
            if (!obj.Monto || !obj.FechaSolicitud) {
                toastr.warning("Por favor complete los campos obligatorios (Fecha y Monto).", "SISTEMA");
                return;
            }

            Swal.fire({
                title: "¿Registrar anticipo?",
                text: "Se creará una nueva solicitud con estado Generado.",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, registrar anticipo",
                cancelButtonText: "Cancelar",
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Reutilizamos el endpoint SolicitarAnticipo (que crea el registro en Generado)
                    $.post('/Liquidacion/SolicitarAnticipo', obj, function(res) {
                        if(res.status) {
                            toastr.success("Anticipo registrado. Ahora suba el voucher.");
                            $('#mdl_NuevoAnticipo').modal('hide');
                            $('#txt_Ant_Monto').val('');
                            $('#txt_Ant_Desc').val('');
                            cargarTodo();
                        } else {
                            toastr.error(res.message);
                        }
                    });
                }
            });
    }

    function abrirModalVoucher(id) {
        $('#hdn_AnticipoId_Transfer').val(id);
        $('#mdl_Voucher').modal('show');
    }

    function fct_GuardarTransferencia() {
        let fd = new FormData();
        fd.append('anticipoId', $('#hdn_AnticipoId_Transfer').val());
        fd.append('nroOperacion', $('#txt_Op').val());
        fd.append('fechaTransferencia', $('#txt_FechaTransfer').val());
        fd.append('archivoVoucher', $('#file_V')[0].files[0]);

        if(!$('#file_V')[0].files[0]){ toastr.warning("Debe adjuntar el voucher"); return; }

        $.ajax({
            url: '/Liquidacion/RegistrarTransferenciaAnticipo',
            type: 'POST',
            data: fd,
            processData: false, contentType: false,
            success: function(res) {
                if(res.status) {
                    toastr.success("Transferencia registrada");
                    $('#mdl_Voucher').modal('hide');
                    cargarTodo();
                } else {
                    toastr.error(res.message);
                }
            }
        });
    }

    // --- COMPROBANTES ---
    function cargarComprobantes() {
        $.getJSON('/Liquidacion/ListarComprobantes', { liquidacionId: liqId }, function(res) {
            let html = '';
            res.data.forEach(c => {
                let botones = '';
                if(c.estado === 'Pendiente') {
                    botones = `
                        <div class="btn-group">
                            <button class="btn btn-success btn-xs btn-auditar" onclick="evaluarComp(${c.id}, 'Aprobado')" title="Aprobar"><i class="fas fa-check"></i></button>
                            <button class="btn btn-danger btn-xs btn-auditar" onclick="evaluarComp(${c.id}, 'Rechazado')" title="Rechazar"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                } else {
                    botones = `<span class="text-muted small"><i class="fas fa-lock"></i> Auditado</span>`;
                }

                let badge = c.estado === 'Aprobado' ? 'success' : (c.estado === 'Rechazado' ? 'danger' : 'warning');

                html += `<tr>
                            <td class="align-middle">${c.fecha}</td>
                            <td class="align-middle">${c.tipoComprobante}<br><small class="text-muted">${c.concepto}</small></td>
                            <td class="align-middle">${c.proveedor}<br><small class="text-muted">${c.serie}</small></td>
                            <td class="align-middle">${c.moneda}</td>
                            <td class="text-right font-weight-bold align-middle">${c.monto.toFixed(2)}</td>
                            <td class="text-center align-middle"><span class="badge badge-${badge}">${c.estado}</span></td>
                            <td class="text-center align-middle">${botones}</td>
                            <td class="text-center align-middle">
                                <a href="${c.archivoUrl}" target="_blank" class="btn btn-default btn-xs"><i class="fas fa-eye"></i></a>
                            </td>
                         </tr>`;
            });
            $('#tbl_Comprobantes tbody').html(html);
        });
    }

    function evaluarComp(id, estado) {
        $.post('/Liquidacion/EvaluarComprobante', { id: id, estado: estado }, function(res) {
            if(res.status) {
                toastr.info("Comprobante " + estado);
                cargarTodo();
            }
        });
    }

    // --- PLANILLA ---
    function cargarPlanilla() {
        $.getJSON('/Liquidacion/ListarDetallesPlanilla', { liquidacionId: liqId }, function(res) {
            let html = '';
            res.data.forEach(d => {
                let estadoHtml = d.aprobado
                    ? '<span class="badge badge-success">Aprobado</span>'
                    : '<span class="badge badge-danger">Rechazado</span>';

                let accion = '';
                if(d.aprobado) {
                    accion = `<button class="btn btn-outline-danger btn-xs btn-auditar" onclick="rechazarItem(${d.id})" title="Rechazar Gasto">
                                <i class="fas fa-times"></i>
                              </button>`;
                }

                html += `<tr>
                            <td class="align-middle">${d.fecha}</td>
                            <td class="align-middle">${d.motivo}<br><small class="text-muted">${d.lugarOrigen} <i class="fas fa-arrow-right"></i> ${d.lugarDestino}</small></td>
                            <td class="text-right align-middle">S/ ${d.monto.toFixed(2)}</td>
                            <td class="text-center align-middle">${estadoHtml}</td>
                            <td class="text-center align-middle">${accion}</td>
                         </tr>`;
            });
            $('#tbl_Planilla tbody').html(html);
        });
    }

    function rechazarItem(id) {
        $.post('/Liquidacion/RechazarItemPlanilla', { id: id }, function(res) {
            if(res.status) {
                toastr.warning("Item rechazado");
                cargarTodo();
            }
        });
    }

    // --- CHAT ---
    function cargarChat() {
        $.getJSON('/Liquidacion/ObtenerObservaciones', { liquidacionId: liqId }, function(res) {
            let html = '';
            if(res.status) {
                res.data.forEach(msg => {
                    let align = msg.esMio ? 'text-right' : 'text-left';
                    let bg = msg.esMio ? 'bg-primary text-white' : 'bg-light text-dark';
                    let user = msg.esMio ? 'Yo' : msg.nombreUsuario;

                    html += `
                        <div class="${align} mb-2">
                            <small class="text-muted font-weight-bold">${user} <span style="font-size:0.7em">${msg.fecha}</span></small>
                            <div class="p-2 rounded ${bg}" style="display:inline-block; max-width:80%; border-radius: 10px;">
                                ${msg.mensaje}
                            </div>
                        </div>
                    `;
                });
            }
            $('#div_ChatBox').html(html);
            $('#div_ChatBox').scrollTop($('#div_ChatBox')[0].scrollHeight);
        });
    }

    function enviarObservacion() {
        let txt = $('#txt_Mensaje').val();
        if(!txt.trim()) return;

        $.post('/Liquidacion/RegistrarObservacion', { liquidacionId: liqId, mensaje: txt, prioridad: 'M' }, function(res) {
            if(res.status) {
                $('#txt_Mensaje').val('');
                cargarChat();
            }
        });
    }

    // --- CIERRE ---
    function fct_CerrarLiquidacion() {
        Swal.fire({
            title: '¿Cerrar Liquidación?',
            text: "Se calculará el saldo final y se cerrará la caja. No hay vuelta atrás.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Sí, Cerrar Caja',
        }).then((result) => {
            if (result.isConfirmed) {
                $.post('/Liquidacion/CerrarLiquidacion', { liquidacionId: liqId }, function(res) {
                    if(res.status) {
                        Swal.fire('Procesado', res.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        toastr.error(res.message);
                    }
                });
            }
        });
    }

     function inicializarInputFile() {
        const dropZone = $('#dropZone');
        const fileInput = $('#file_V');

        fileInput.on('click', function(e) { e.stopPropagation(); });
        dropZone.on('click', function(e) {
            if(e.target.id !== 'btn_RemoveFile' && e.target.parentNode.id !== 'btn_RemoveFile') {
                fileInput.trigger('click');
            }
        });
        dropZone.on('dragover', function(e) { e.preventDefault(); e.stopPropagation(); $(this).addClass('drag-over'); });
        dropZone.on('dragleave', function(e) { e.preventDefault(); e.stopPropagation(); $(this).removeClass('drag-over'); });
        dropZone.on('drop', function(e) {
            e.preventDefault(); e.stopPropagation(); $(this).removeClass('drag-over');
            if (e.originalEvent.dataTransfer.files.length) {
                fileInput[0].files = e.originalEvent.dataTransfer.files;
                mostrarPreview(fileInput[0].files[0]);
            }
        });
        fileInput.on('change', function() { if(this.files.length) mostrarPreview(this.files[0]); });
        $('#btn_RemoveFile').on('click', function(e){
            e.stopPropagation(); e.preventDefault();
            fileInput.val(''); $('#previewArea').hide(); $('#lbl_DropInfo').show();
        });
        function mostrarPreview(file) {
            $('#lbl_DropInfo').hide(); $('#name_Preview').text(file.name); $('#previewArea').show();
            if(file.type.includes('pdf')) $('#icon_Preview').attr('class', 'fas fa-file-pdf text-danger fa-2x');
            else $('#icon_Preview').attr('class', 'fas fa-file-image text-primary fa-2x');
        }
    }
</script>