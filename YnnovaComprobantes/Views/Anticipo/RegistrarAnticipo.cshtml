@{
    ViewData["Title"] = "Registrar anticipo";
}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="text-center mb-0">Registrar anticipo</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Empresa">Empresa</label>
                            <select id="cbx_Empresa" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Usuario">Usuario</label>
                            <select id="cbx_Usuario" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_FechaSolicitud">Fecha de Solicitud</label>
                            <input type="date" id="txt_FechaSolicitud" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_FechaLimiteRendicion">Fecha límite de rendición</label>
                            <input type="date" id="txt_FechaLimiteRendicion" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_TipoRendicion">Tipo de rendición</label>
                            <select id="cbx_TipoRendicion" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Banco">Banco (Depósito)</label>
                            <select id="cbx_Banco" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cbx_Moneda">Moneda</label>
                            <select id="cbx_Moneda" class="form-control"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txt_Monto">Monto solicitado</label>
                            <input type="number" id="txt_Monto" class="form-control" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="txt_Descripcion">Descripción (opcional)</label>
                            <textarea id="txt_Descripcion" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-12 text-center">
                            <hr>
                            <button id="btn_Volver" type="button" class="btn btn-danger">Volver</button>
                            <button id="btn_Registrar" type="button" class="btn btn-primary">Registrar anticipo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        
        let fSolicitud = new Date($('#txt_FechaSolicitud').val());
        let fLimite = new Date($('#txt_FechaLimiteRendicion').val());

        if (fLimite < fSolicitud) {
            toastr.error("La fecha límite no puede ser anterior a la fecha de solicitud", "SISTEMA");
            return;
        }
        
        $('#txt_FechaSolicitud').on('change', function () {
            let fechaSeleccionada = $(this).val();

            if (fechaSeleccionada) {
                let date = new Date(fechaSeleccionada);

                date.setDate(date.getDate() + 7);

                let año = date.getFullYear();
                let mes = ("0" + (date.getMonth() + 1)).slice(-2);
                let dia = ("0" + date.getDate()).slice(-2);

                let fechaLimite = `${año}-${mes}-${dia}`;

                $('#txt_FechaLimiteRendicion').val(fechaLimite);
            }
        });

        if ($('#txt_FechaSolicitud').val()) {
            $('#txt_FechaSolicitud').trigger('change');
        }

        // Inicializar selectores de datos
        fct_GetEmpresas();
        fct_GetTipoRendicion();
        fct_GetBancos();
        fct_GetMonedas();

        // --- Funciones de Carga de Datos (abreviadas para brevedad) ---
        function fct_GetEmpresas() {
            $.getJSON('/Anticipo/GetEmpresaData', function (res) {
                if (res.status) {
                    let data = res.data.map(e => ({ id: e.id, text: e.ruc + ' - ' + e.nombre }));
                    $('#cbx_Empresa').select2({ theme: 'bootstrap4', data: data, placeholder: "Seleccionar Empresa" }).val(null).trigger('change');
                }
            });
        }

        $('#cbx_Empresa').on('change', function() {
            let id = $(this).val();
            if(!id) return;
            $.getJSON('/Anticipo/GetUsuariosData', { 'EmpresaId': id }, function (res) {
                if (res.status) {
                    let data = res.data.map(u => ({ id: u.id, text: u.dni + ' - ' + u.nombre }));
                    $('#cbx_Usuario').empty().select2({ theme: 'bootstrap4', data: data, placeholder: "Seleccionar Usuario" });
                }
            });
        });

        function fct_GetTipoRendicion() {
            $.getJSON('/Anticipo/GetTiposRendicionesData', function (res) {
                if (res.status) {
                    let data = res.data.map(t => ({ id: t.id, text: t.codigo + ' - ' + t.descripcion }));
                    $('#cbx_TipoRendicion').select2({ theme: 'bootstrap4', data: data, placeholder: "Seleccionar Tipo" });
                }
            });
        }

        function fct_GetBancos() {
            $.getJSON('/Anticipo/GetBancosData', function (res) {
                if (res.status) {
                    let data = res.data.map(b => ({ id: b.id, text: b.codigo + ' - ' + b.descripcion }));
                    $('#cbx_Banco').select2({ theme: 'bootstrap4', data: data, placeholder: "Seleccionar Banco" });
                }
            });
        }

        function fct_GetMonedas() {
            $.getJSON('/Anticipo/GetMonedasData', function (res) {
                if (res.status) {
                    let opt = '<option value="" disabled selected>--SELECCIONAR--</option>';
                    res.data.forEach(m => opt += `<option value="${m.id}">${m.simbolo} ${m.nombre}</option>`);
                    $('#cbx_Moneda').html(opt);
                }
            });
        }

        // --- Evento de Registro ---
        $("#btn_Registrar").click(function () {
            // Recolección de datos
            let obj = {
                EmpresaId: $('#cbx_Empresa').val(),
                UsuarioId: $('#cbx_Usuario').val(),
                FechaSolicitud: $('#txt_FechaSolicitud').val(),
                FechaLimiteRendicion: $('#txt_FechaLimiteRendicion').val(),
                TipoRendicionId: $('#cbx_TipoRendicion').val(), // FK de la tabla
                BancoId: $('#cbx_Banco').val(),
                MonedaId: $('#cbx_Moneda').val(),
                Monto: $('#txt_Monto').val(),
                Descripcion: $('#txt_Descripcion').val()
            };

            // Validación simple
            if (!obj.EmpresaId || !obj.UsuarioId || !obj.Monto || !obj.FechaSolicitud) {
                toastr.warning("Por favor complete los campos obligatorios (Empresa, Usuario, Fecha y Monto).", "SISTEMA");
                return;
            }

            Swal.fire({
                title: "¿Registrar anticipo?",
                text: "Se creará una nueva solicitud con estado Pendiente.",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, registrar anticipo",
                cancelButtonText: "Cancelar",
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "/Anticipo/RegistrarAnticipo",
                        type: "POST",
                        data: obj, // Enviamos el objeto directamente
                        success: function (response) {
                            if (response.status) {
                                toastr.success(response.message, "ÉXITO");
                                setTimeout(() => window.location.href = "/Anticipo", 1500);
                            } else {
                                toastr.error(response.message, "ERROR");
                            }
                        }
                    });
                }
            });
        });

        $("#btn_Volver").click(function () { window.location.href = "/Anticipo"; });
    });
</script>