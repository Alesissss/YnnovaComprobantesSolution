@model YnnovaComprobantes.ViewModels.EditarAnticipoViewModel
@{
    ViewData["Title"] = "Evaluación del Anticipo #" + Model.Anticipo.Id;
}

<style>
    /* Estilos del Chat (Sin cambios) */
    .chat-box {
        max-height: 350px;
        overflow-y: auto;
        padding: 10px;
        background: #f4f6f9;
        border-radius: 5px;
    }

    .direct-chat-msg {
        margin-bottom: 10px;
    }

    .direct-chat-text {
        border-radius: .3rem;
        background: #d2d6de;
        border: 1px solid #d2d6de;
        color: #444;
        margin: 5px 0 0 50px;
        padding: 5px 10px;
        position: relative;
    }

    .right .direct-chat-text {
        background: #3b8bba;
        border-color: #3b8bba;
        color: #fff;
        margin-left: 0;
        margin-right: 50px;
    }

    /* Loading para selects */
    select.loading {
        background-color: #f0f0f0;
        color: #888;
    }

    /* Ajuste botones tabla */
    .btn-action {
        margin-right: 3px;
    }
</style>

<div class="container-fluid pt-3">
    <div class="row">

        <div class="col-md-4">

            <div class="card card-primary shadow-sm mb-3">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-edit"></i> Datos del Anticipo</h3>
                    <div class="card-tools">
                        <span class="badge badge-warning">@Model.Estado?.Nombre</span>
                    </div>
                </div>
                <div class="card-body">
                    <form id="frm_EditarAnticipo">
                        <input type="hidden" id="hdn_AnticipoId" value="@Model.Anticipo.Id">
                        <div class="row">
                            <div class="col-md-12 mb-2">
                                <label>Empresa</label>
                                <select id="cbx_Ant_Empresa" class="form-control form-control-sm loading"></select>
                            </div>
                            <div class="col-md-12 mb-2">
                                <label>Usuario Solicitante</label>
                                <select id="cbx_Ant_Usuario" class="form-control form-control-sm loading" disabled>
                                    <option value="">-- Seleccione Empresa primero --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Banco</label>
                                <select id="cbx_Ant_Banco" class="form-control form-control-sm loading"></select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Tipo Rendición</label>
                                <select id="cbx_Ant_TipoRendicion" class="form-control form-control-sm loading"></select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Moneda</label>
                                <select id="cbx_Ant_Moneda" class="form-control form-control-sm loading"></select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Monto</label>
                                <input type="number" id="txt_Ant_Monto" class="form-control form-control-sm" value="@Model.Anticipo.Monto" step="0.01">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Fecha Solicitud</label>
                                <input type="date" id="txt_Ant_Fecha" class="form-control form-control-sm" value="@(Model.Anticipo.FechaSolicitud?.ToString("yyyy-MM-dd"))">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Fecha Límite</label>
                                <input type="date" id="txt_Ant_FechaLimite" class="form-control form-control-sm" value="@(Model.Anticipo.FechaLimiteRendicion?.ToString("yyyy-MM-dd"))">
                            </div>
                            <div class="col-12 mb-2">
                                <label>Descripción</label>
                                <textarea id="txt_Ant_Descripcion" class="form-control form-control-sm" rows="2">@Model.Anticipo.Descripcion</textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-right">
                    <button type="button" class="btn btn-danger btn-sm" onclick="fct_Volver()">Volver</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="fct_ActualizarAnticipo()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>

            <div class="card card-warning shadow-sm">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-comments"></i> Observaciones</h3>
                </div>
                <div class="card-body p-0">
                    <div class="chat-box" id="div_ChatBox">
                        <div class="text-center text-muted mt-5">Cargando comentarios...</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group mb-2">
                        <select id="sel_Prioridad" class="form-control form-control-sm" style="max-width: 100px;">
                            <option value="B">Baja</option>
                            <option value="M">Media</option>
                            <option value="A">Alta</option>
                        </select>
                        <input type="text" id="txt_MensajeChat" placeholder="Escribe una observación..." class="form-control form-control-sm">
                        <span class="input-group-append">
                            <button type="button" class="btn btn-warning btn-sm" onclick="fct_EnviarObservacion()">Enviar</button>
                        </span>
                    </div>
                    <small class="text-muted"><i class="fas fa-info-circle"></i> Al enviar, los pendientes pasarán a "Observado".</small>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card card-secondary shadow-sm">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-check-double"></i> Evaluación de Comprobantes</h3>
                </div>
                <div class="card-body">
                    <table id="tbl_ComprobantesDetalle" class="table table-bordered table-striped table-sm w-100">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Monto</th>
                                <th>Archivo</th>
                                <th class="text-center" style="width: 100px;">Estado</th>
                                <th class="text-center" style="width: 90px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables de inicio
    var anticipoId = @Model.Anticipo.Id;
    var usuarioLogueadoId = @Model.UsuarioLogueadoId;

    // Valores para selects
    var selEmpresaId = @(Model.Anticipo.EmpresaId.HasValue? Model.Anticipo.EmpresaId.Value : 0);
    var selUsuarioId = @(Model.Anticipo.UsuarioId.HasValue? Model.Anticipo.UsuarioId.Value : 0);
    var selBancoId = @(Model.Anticipo.BancoId.HasValue? Model.Anticipo.BancoId.Value : 0);
    var selTipoRendicionId = @(Model.Anticipo.TipoRendicionId.HasValue? Model.Anticipo.TipoRendicionId.Value : 0);
    var selMonedaId = @(Model.Anticipo.MonedaId);

    $(document).ready(function () {
        cargarListasIniciales();

        $('#cbx_Ant_Empresa').change(function() {
            let idEmpresa = $(this).val();
            if(idEmpresa) cargarUsuarios(idEmpresa, null);
            else $('#cbx_Ant_Usuario').html('<option value="">-- Seleccione Empresa --</option>').prop('disabled', true);
        });

        initTableComprobantes();
        cargarObservaciones();
    });

    // ==========================================
    // LOGICA DROPDOWNS (ADMIN)
    // ==========================================
    function cargarListasIniciales() {
        cargarDropdown('/Anticipo/GetEmpresaData', '#cbx_Ant_Empresa', selEmpresaId)
            .then(() => { if(selEmpresaId > 0) cargarUsuarios(selEmpresaId, selUsuarioId); });
        cargarDropdown('/Anticipo/GetBancosData', '#cbx_Ant_Banco', selBancoId);
        cargarDropdown('/Anticipo/GetTiposRendicionesData', '#cbx_Ant_TipoRendicion', selTipoRendicionId);
        cargarDropdown('/Anticipo/GetMonedasData', '#cbx_Ant_Moneda', selMonedaId);
    }

    function cargarUsuarios(empresaId, usuarioSeleccionadoId) {
        let $select = $('#cbx_Ant_Usuario');
        $select.prop('disabled', true).html('<option>Cargando...</option>');
        $.getJSON('/Anticipo/GetUsuariosData', { EmpresaId: empresaId }, function(resp) {
            if(resp.status) {
                let html = '<option value="">-- Seleccionar --</option>';
                resp.data.forEach(u => { html += `<option value="${u.id}">${u.nombre}</option>`; });
                $select.html(html).prop('disabled', false).removeClass('loading');
                if(usuarioSeleccionadoId > 0) $select.val(usuarioSeleccionadoId);
            }
        });
    }

    function cargarDropdown(url, selector, valorPreSeleccionado) {
        let $select = $(selector);
        $select.html('<option>Cargando...</option>').addClass('loading');
        return $.getJSON(url, function(resp) {
            if(resp.status) {
                let html = '<option value="">-- Seleccionar --</option>';
                resp.data.forEach(item => {
                    let texto = item.nombre || item.descripcion;
                    if(item.simbolo) texto = `${item.nombre} (${item.simbolo})`;
                    html += `<option value="${item.id}">${texto}</option>`;
                });
                $select.html(html).removeClass('loading');
                if(valorPreSeleccionado && valorPreSeleccionado > 0) $select.val(valorPreSeleccionado);
            }
        });
    }

    // ==========================================
    // ACTUALIZAR ANTICIPO
    // ==========================================
    function fct_ActualizarAnticipo() {
        let obj = {
            Id: $('#hdn_AnticipoId').val(),
            EmpresaId: $('#cbx_Ant_Empresa').val(),
            UsuarioId: $('#cbx_Ant_Usuario').val(),
            BancoId: $('#cbx_Ant_Banco').val(),
            TipoRendicionId: $('#cbx_Ant_TipoRendicion').val(),
            MonedaId: $('#cbx_Ant_Moneda').val(),
            Descripcion: $('#txt_Ant_Descripcion').val(),
            Monto: $('#txt_Ant_Monto').val(),
            FechaSolicitud: $('#txt_Ant_Fecha').val(),
            FechaLimiteRendicion: $('#txt_Ant_FechaLimite').val()
        };

        if (!obj.EmpresaId || !obj.UsuarioId || !obj.Monto) {
            toastr.warning("Por favor completa los datos esenciales.");
            return;
        }

        $.post("/Anticipo/ActualizarAnticipoDatos", obj, function(resp){
            if(resp.status) toastr.success(resp.message);
            else toastr.error(resp.message);
        });
    }

    // ==========================================
    // TABLA COMPROBANTES (CON ACCIONES DE APROBAR/RECHAZAR)
    // ==========================================
    function initTableComprobantes() {
        $('#tbl_ComprobantesDetalle').DataTable({
            paging: true,
            select: true,
            scroller: false,
            deferRender: true,
            scrollY: true,
            scrollX: true,
            fixedHeader: true,
            ordering: true,
            destroy: true,
            responsive: true,
            autoWidth: false,
            processing: true,
            filter: true,
            orderMulti: true,
            stateSave: false,
            serverSide: false,
            language: {
                processing: "Procesando...",
                sSearch: "Buscar:",
                lengthMenu: "Mostrar _MENU_ registros",
                info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                infoEmpty: "Sin registros encontrados.",
                infoFiltered: "(Total de _MAX_ registros filtrados)",
                loadingRecords: "Cargando...",
                zeroRecords: "No se encontraron registros",
                emptyTable: "No hay datos disponibles en la tabla",
                paginate: {
                    previous: "Anterior",
                    next: "Siguiente",
                    first: "Primero",
                    last: "Último",
                },
                aria: {
                    sortAscending: ": Activar para ordenar la columna de manera ascendente",
                    sortDescending: ": Activar para ordenar la columna de manera descendente"
                },
                select: {
                    rows: {
                        _: "%d filas seleccionadas",
                        0: "Haz clic en una fila para seleccionarla",
                        1: "1 fila seleccionada"
                    }
                },
                buttons: {
                    copyTitle: 'Copiado en el portapapeles',
                    copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                    copySuccess: {
                        _: '%d registros copiados correctamente',
                        1: '1 registro copiado correctamente'
                    }
                }
            },
            lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
            responsive: true,
            ajax: { url: '/Anticipo/GetComprobantesPorAnticipo?anticipoId=' + anticipoId, type: 'GET', dataSrc: function(json) { return json.data; } },
            columns: [
                { data: 'fechaEmision', render: d => moment(d).format('DD/MM/YYYY') },
                { data: 'proveedorNombre', render: (d,t,r) => `<div>${r.rucEmpresa}</div><small class="text-muted">${r.serie}-${r.numero}</small>` },
                { data: 'montoTotal', render: d => parseFloat(d).toFixed(2) },
                {
                    data: 'archivoUrl',
                    render: function(data) {
                        if(data) return `<a href="${data}" target="_blank" class="btn btn-xs btn-info"><i class="fas fa-eye"></i></a>`;
                        return '<span class="text-muted">-</span>';
                    }
                },
                {
                    // COLUMNA ESTADO (BADGE)
                    data: 'estadoNombre', // Asegúrate que tu DTO retorne el nombre del estado
                    render: function(data) {
                        let badgeClass = 'secondary';
                        if(data === 'Pendiente') badgeClass = 'info';
                        else if(data === 'Aprobado') badgeClass = 'success';
                        else if(data === 'Rechazado') badgeClass = 'danger';
                        else if(data === 'Observado') badgeClass = 'warning';
                        return `<span class="badge badge-${badgeClass}">${data || 'Pendiente'}</span>`;
                    }
                },
                {
                    // COLUMNA ACCIONES (BOTONES)
                    data: null,
                    render: function(data, type, row) {
                        // Solo mostramos botones si no está ya aprobado/rechazado (opcional, pero recomendado)
                        // Aquí dejo los botones siempre activos para que el admin pueda corregir.
                        if (data.estadoNombre === 'Aprobado' || data.estadoNombre === 'Rechazado') {
                            return `<span class="text-muted" title="Ya no se puede modificar el estado"><i class="fas fa-lock"></i></span>`
                        } else {
                            return `
                                <button class="btn btn-xs btn-success btn-action" title="Aprobar" onclick="cambiarEstado(${data.id}, 'Aprobado')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-xs btn-danger btn-action" title="Rechazar" onclick="cambiarEstado(${data.id}, 'Rechazado')">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }
                    },
                    orderable: false,
                }
            ],
            columnDefs: [
                { targets: '_all', className: 'align-middle' },
                { targets: [3, 4, 5], className: 'text-center' }
            ]
        });
    }

    // Acción AJAX para Aprobar/Rechazar individualmente
    function cambiarEstado(idComprobante, nuevoEstado) {
        // Confirmación suave con Toast o Swal simple
        Swal.fire(
            {
                title: '¿Cambiar estado del comprobante?',
                text: "Esta acción cambiará el estado del comprobante a " + nuevoEstado,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, actualizar estado del comprobante",
                cancelButtonText: "Cancelar",
                reverseButtons: true
            }).then((r) => {
            if(r.isConfirmed) {
                $.post('/Anticipo/CambiarEstadoComprobante', { comprobanteId: idComprobante, nuevoEstadoNombre: nuevoEstado }, function(resp) {
                    if(resp.status) {
                        toastr.success(resp.message);
                        $('#tbl_ComprobantesDetalle').DataTable().ajax.reload(null, false); // Reload sin perder paginación
                    } else {
                        toastr.error(resp.message);
                    }
                });
            }
        });
    }

    // ==========================================
    // CHAT & LOGICA MASIVA
    // ==========================================
    function cargarObservaciones() {
        $.getJSON('/Anticipo/GetObservaciones?anticipoId=' + anticipoId, function(resp) {
            let html = '';
            if(resp.status && resp.data.length > 0) {
                resp.data.forEach(obs => {
                    let esMio = obs.usuarioId === usuarioLogueadoId;
                    let alineacion = esMio ? 'right' : 'left';
                    let nombreUsuario = esMio ? 'Yo' : obs.nombreUsuario;
                    let colorPrioridad = obs.prioridad === 'A' ? 'text-danger' : (obs.prioridad === 'M' ? 'text-warning' : 'text-success');
                    let fecha = moment(obs.fechaCreacion).format('DD/MM HH:mm');
                    html += `<div class="direct-chat-msg ${alineacion}"><div class="direct-chat-infos clearfix"><span class="direct-chat-name float-${alineacion}">${nombreUsuario}</span><span class="direct-chat-timestamp float-${esMio ? 'left' : 'right'}">${fecha}</span></div><div class="direct-chat-text"><i class="fas fa-circle ${colorPrioridad} small" title="Prioridad"></i> ${obs.mensaje}</div></div>`;
                });
            } else { html = '<p class="text-center text-muted small mt-4">No hay observaciones registradas.</p>'; }
            $('#div_ChatBox').html(html).scrollTop($('#div_ChatBox')[0].scrollHeight);
        });
    }

    function fct_EnviarObservacion() {
        let msg = $('#txt_MensajeChat').val();
        let pri = $('#sel_Prioridad').val();

        if(!msg.trim()) return;

        $.post('/Anticipo/RegistrarObservacion', { AnticipoId: anticipoId, Mensaje: msg, Prioridad: pri }, function(resp) {
            if(resp.status) {
                $('#txt_MensajeChat').val('');

                cargarObservaciones();

                $('#tbl_ComprobantesDetalle').DataTable().ajax.reload();

                toastr.info("Observación enviada. Comprobantes pendientes marcados como observados.");
            } else {
                toastr.error(resp.message);
            }
        });
    }

    function fct_Volver() {
        window.location.href = '/Anticipo';
    }
</script>