@model YnnovaComprobantes.ViewModels.GestionPlanillaViewModel
@{
    ViewData["Title"] = "Evaluación de Planilla #" + Model.Planilla.NumeroPlanilla;
}

<style>
    .chat-box {
        max-height: 350px;
        overflow-y: auto;
        padding: 10px;
        background: #f4f6f9;
        border-radius: 5px;
    }

    .direct-chat-msg {
        margin-bottom: 10px;
    }

    .direct-chat-text {
        border-radius: .3rem;
        background: #d2d6de;
        border: 1px solid #d2d6de;
        color: #444;
        margin: 5px 0 0 50px;
        padding: 5px 10px;
        position: relative;
    }

    .right .direct-chat-text {
        background: #3b8bba;
        border-color: #3b8bba;
        color: #fff;
        margin-left: 0;
        margin-right: 50px;
    }

    select.loading {
        background-color: #f0f0f0;
        color: #888;
    }
</style>

<div class="container-fluid pt-3">
    <div class="row">
        <div class="col-md-4">
            <div class="card card-dark shadow-sm mb-3">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-edit"></i> Datos de Asignación</h3>
                    <div class="card-tools">
                        <span class="badge badge-warning">@Model.Estado?.Nombre</span>
                    </div>
                </div>
                <div class="card-body">
                    <form id="frm_EditarPlanilla">
                        <input type="hidden" id="hdn_PlanillaId" value="@Model.Planilla.Id">
                        <div class="form-group mb-2">
                            <label class="small">Empresa</label>
                            <select id="cbx_Pla_Empresa" class="form-control form-control-sm loading"></select>
                        </div>
                        <div class="form-group mb-2">
                            <label class="small">Usuario Beneficiario</label>
                            <select id="cbx_Pla_Usuario" class="form-control form-control-sm loading" disabled></select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="small">Fecha Emisión</label>
                                <input type="date" id="txt_Pla_Fecha" class="form-control form-control-sm" value="@Model.Planilla.FechaEmision.ToString("yyyy-MM-dd")">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="small">Presupuesto (S/)</label>
                                <input type="number" id="txt_Pla_Monto" class="form-control form-control-sm" value="@Model.Planilla.MontoTotal" step="0.01">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-right">
                    <button type="button" class="btn btn-danger btn-sm" onclick="fct_Volver()">Volver</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="fct_ActualizarPlanilla()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>

            <div class="card card-warning shadow-sm">
                <div class="card-header"><h3 class="card-title small"><i class="fas fa-comments"></i> Observaciones</h3></div>
                <div class="card-body p-0">
                    <div class="chat-box" id="div_ChatBox">
                        <div class="text-center text-muted mt-5">Cargando comentarios...</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="txt_MensajeChat" placeholder="Escribir observación..." class="form-control form-control-sm">
                        <span class="input-group-append">
                            <button type="button" class="btn btn-warning btn-sm" onclick="fct_EnviarObservacion()">Enviar</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card card-secondary shadow-sm">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list-ul"></i> Trayectos Registrados por el Usuario</h3>
                </div>
                <div class="card-body">
                    <table id="tbl_DetallesPlanilla" class="table table-bordered table-striped table-sm w-100">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Motivo</th>
                                <th>Origen</th>
                                <th>Destino</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card-footer text-right">
                    <h5 id="lbl_TotalAcumulado">Total Acumulado: S/ 0.00</h5>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var planillaId = @Model.Planilla.Id;
    var usuarioLogueadoId = @Model.UsuarioLogueadoId;
    var selEmpresaId = @Model.Planilla.EmpresaId;
    var selUsuarioId = @Model.Planilla.UsuarioId;

    $(document).ready(function () {
        cargarListas();
        initTableDetalles();
        cargarObservaciones();

        $('#cbx_Pla_Empresa').change(function() {
            let id = $(this).val();
            if(id) cargarUsuarios(id, null);
        });
    });

    function cargarListas() {
        cargarDropdown('/PlanillaMovilidad/GetEmpresaData', '#cbx_Pla_Empresa', selEmpresaId)
            .then(() => { if(selEmpresaId > 0) cargarUsuarios(selEmpresaId, selUsuarioId); });
    }

    function cargarUsuarios(empresaId, usuarioSeleccionadoId) {
        let $select = $('#cbx_Pla_Usuario');
        $select.prop('disabled', true).html('<option>Cargando...</option>');
        $.getJSON('/PlanillaMovilidad/GetUsuariosData', { EmpresaId: empresaId }, function(resp) {
            if(resp.status) {
                let html = '<option value="">-- Seleccionar --</option>';
                resp.data.forEach(u => { html += `<option value="${u.id}">${u.dni} - ${u.nombre}</option>`; });
                $select.html(html).prop('disabled', false).removeClass('loading');
                if(usuarioSeleccionadoId > 0) $select.val(usuarioSeleccionadoId);
            }
        });
    }

    function cargarDropdown(url, selector, valor) {
        let $select = $(selector);
        return $.getJSON(url, function(resp) {
            if(resp.status) {
                let html = '<option value="">-- Seleccionar --</option>';
                resp.data.forEach(item => { html += `<option value="${item.id}">${item.nombre}</option>`; });
                $select.html(html).removeClass('loading');
                if(valor > 0) $select.val(valor);
            }
        });
    }

    function initTableDetalles() {
        $('#tbl_DetallesPlanilla').DataTable({
            ajax: { url: '/PlanillaMovilidad/GetDetallesData?planillaId=' + planillaId, type: 'GET', dataSrc: 'data' },
            columns: [
                { data: 'fechaGasto' },
                { data: 'motivo' },
                { data: 'lugarOrigen' },
                { data: 'lugarDestino' },
                { data: 'monto', render: d => 'S/ ' + parseFloat(d).toFixed(2) }
            ],
            "drawCallback": function(settings) {
                if(settings.json) $('#lbl_TotalAcumulado').text("Total Acumulado: S/ " + parseFloat(settings.json.totalGastado).toFixed(2));
            }
        });
    }

    function fct_ActualizarPlanilla() {
        let obj = {
            Id: planillaId,
            EmpresaId: $('#cbx_Pla_Empresa').val(),
            UsuarioId: $('#cbx_Pla_Usuario').val(),
            FechaEmision: $('#txt_Pla_Fecha').val(),
            MontoTotal: $('#txt_Pla_Monto').val()
        };

        $.post("/PlanillaMovilidad/ActualizarPlanillaDatos", obj, function(resp){
            if(resp.status) toastr.success(resp.message);
            else toastr.error(resp.message);
        });
    }

    function cargarObservaciones() {
        $.getJSON('/PlanillaMovilidad/GetObservaciones?planillaId=' + planillaId, function(resp) {
            let html = '';
            if(resp.status && resp.data.length > 0) {
                resp.data.forEach(obs => {
                    let esMio = obs.usuarioId === usuarioLogueadoId;
                    let alineacion = esMio ? 'right' : 'left';
                    html += `<div class="direct-chat-msg ${alineacion}"><div class="direct-chat-infos clearfix"><span class="direct-chat-name float-${alineacion}">${esMio ? 'Yo' : obs.nombreUsuario}</span></div><div class="direct-chat-text">${obs.mensaje}</div></div>`;
                });
            } else { html = '<p class="text-center text-muted small mt-4">Sin observaciones.</p>'; }
            $('#div_ChatBox').html(html).scrollTop($('#div_ChatBox')[0].scrollHeight);
        });
    }

    function fct_EnviarObservacion() {
        let msg = $('#txt_MensajeChat').val();
        if(!msg.trim()) return;
        $.post('/PlanillaMovilidad/RegistrarObservacion', { PlanillaId: planillaId, Mensaje: msg, Prioridad: 'B' }, function(resp) {
            if(resp.status) {
                $('#txt_MensajeChat').val('');
                cargarObservaciones();
            }
        });
    }

    function fct_Volver() { window.location.href = '/PlanillaMovilidad'; }
</script>