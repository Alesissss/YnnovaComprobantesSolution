@{
    ViewData["Title"] = "Dashboard de Rendiciones";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<style>
    /* --- Estilos Generales & Responsivos --- */
    .dashboard-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        background: white;
        margin-bottom: 25px;
        transition: transform 0.3s ease;
        overflow: hidden; /* Importante para bordes redondeados */
    }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

    .card-header-custom {
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
        padding: 15px 20px;
        font-weight: 700;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* KPI BOXES con degradados */
    .info-box-custom {
        color: white;
        border-radius: 12px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px; /* Espacio en móvil */
    }

    .bg-gradient-primary {
        background: linear-gradient(45deg, #4099ff, #73b4ff);
    }

    .bg-gradient-success {
        background: linear-gradient(45deg, #2ed8b6, #59e0c5);
    }

    .bg-gradient-warning {
        background: linear-gradient(45deg, #FFB64D, #ffcb80);
    }

    .bg-gradient-danger {
        background: linear-gradient(45deg, #FF5370, #ff869a);
    }

    .info-box-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3.5rem;
        opacity: 0.25;
    }

    .info-box-value {
        font-size: 2rem;
        font-weight: 800;
        margin: 0;
        position: relative;
        z-index: 1;
    }

    .info-box-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }

    /* Contenedor Gráfico Responsivo */
    .chart-container {
        position: relative;
        height: 350px; /* Altura base */
        width: 100%; /* Ancho total del padre */
        overflow: hidden;
    }

    /* Filtros */
    .filter-container {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        margin-bottom: 20px;
    }

    /* Ajuste para móviles en filtros */
    @@media (max-width: 768px) {
        .filter-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .form-inline {
            width: 100%;
            margin-top: 10px;
            flex-direction: column;
        }

        .input-group {
            width: 100% !important;
            margin-bottom: 10px;
        }

        .btn-filter {
            width: 100%;
        }
    }
</style>

<div class="container-fluid mt-3">

    <div class="filter-container d-flex flex-wrap justify-content-between align-items-center">
        <div class="mb-2 mb-md-0">
            <h3 class="font-weight-bold text-dark mb-0">Resumen Financiero</h3>
            <p class="text-muted mb-0 small">Control de rendiciones</p>
        </div>
        <div class="form-inline d-flex">
            <div class="input-group input-group-sm mr-md-2 mb-2 mb-md-0">
                <div class="input-group-prepend"><span class="input-group-text bg-white border-0 font-weight-bold">Del:</span></div>
                <input type="date" id="txtFechaInicio" class="form-control shadow-sm border-0" style="background:#f8f9fa;">
            </div>
            <div class="input-group input-group-sm mr-md-2 mb-2 mb-md-0">
                <div class="input-group-prepend"><span class="input-group-text bg-white border-0 font-weight-bold">Al:</span></div>
                <input type="date" id="txtFechaFin" class="form-control shadow-sm border-0" style="background:#f8f9fa;">
            </div>
            <button class="btn btn-primary btn-sm shadow-sm font-weight-bold px-3 btn-filter" onclick="cargarDashboard()">
                <i class="fas fa-filter mr-1"></i> Filtrar
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="info-box-custom bg-gradient-primary">
                <div class="info-box-label">Gasto Total</div>
                <h3 class="info-box-value" id="lblTotalGasto">S/ 0.00</h3>
                <i class="fas fa-coins info-box-icon"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="info-box-custom bg-gradient-warning">
                <div class="info-box-label">Pendientes</div>
                <h3 class="info-box-value" id="lblPendientes">0</h3>
                <i class="fas fa-hourglass-half info-box-icon"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="info-box-custom bg-gradient-success">
                <div class="info-box-label">Aprobados</div>
                <h3 class="info-box-value" id="lblAprobados">0</h3>
                <i class="fas fa-check-circle info-box-icon"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="info-box-custom bg-gradient-danger">
                <div class="info-box-label">Observados</div>
                <h3 class="info-box-value" id="lblObservados">0</h3>
                <i class="fas fa-exclamation-circle info-box-icon"></i>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="dashboard-card h-100">
                <div class="card-header-custom">
                    <span><i class="fas fa-chart-line text-primary mr-2"></i> Evolución de Gastos</span>
                </div>
                <div class="card-body">
                    <div id="chartTrend" class="chart-container"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="dashboard-card h-100">
                <div class="card-header-custom">
                    <span><i class="fas fa-chart-pie text-warning mr-2"></i> Flujo de Dinero</span>
                </div>
                <div class="card-body">
                    <div id="chartType" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card h-100">
                <div class="card-header-custom">
                    <span><i class="fas fa-tags text-success mr-2"></i> Gastos por Concepto</span>
                </div>
                <div class="card-body">
                    <div id="chartConceptos" class="chart-container"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card h-100">
                <div class="card-header-custom">
                    <span><i class="fas fa-clipboard-list text-info mr-2"></i> Estado Liquidaciones</span>
                </div>
                <div class="card-body">
                    <div id="chartStatus" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Variables globales
        let chartTrend, chartType, chartConceptos, chartStatus;

        $(document).ready(function () {
            initFechas();
            cargarDashboard();
        });

        // 1. Inicializar Fechas (Año Actual)
        function initFechas() {
            const now = new Date();
            const year = now.getFullYear();

            // Ajustamos horas para evitar problemas de zona horaria al convertir a ISO
            const firstDay = new Date(year, 0, 1, 12, 0, 0);
            const lastDay = new Date(year, 11, 31, 12, 0, 0);

            $('#txtFechaInicio').val(firstDay.toISOString().split('T')[0]);
            $('#txtFechaFin').val(lastDay.toISOString().split('T')[0]);
        }

        // 2. Cargar Datos AJAX
        function cargarDashboard() {
            const fi = $('#txtFechaInicio').val();
            const ff = $('#txtFechaFin').val();

            // Pequeño indicador de carga en botón
            const btn = $('.btn-filter');
            const originalText = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

            $.ajax({
                url: '@Url.Action("GetDashboardData", "Home")',
                type: 'GET',
                data: { fechaInicio: fi, fechaFin: ff },
                success: function (res) {
                    if (res.status) {
                        renderKPIs(res.data);
                        renderCharts(res.data);
                    } else {
                        console.error(res.message);
                    }
                },
                complete: function() {
                    btn.html(originalText).prop('disabled', false);
                }
            });
        }

        function renderKPIs(data) {
            const fmt = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' });
            $('#lblTotalGasto').text(fmt.format(data.gastoTotal));
            $('#lblPendientes').text(data.pendientes);
            $('#lblAprobados').text(data.aprobados);
            $('#lblObservados').text(data.observados);
        }

        // 3. Renderizar Gráficos Responsivos
        function renderCharts(data) {
            // Configuración común para responsividad en gráficos cartesianos (Barras/Líneas)
            // 'containLabel: true' evita que los textos se corten en móviles
            const gridConfig = { left: '3%', right: '4%', bottom: '3%', containLabel: true };

            // --- A. LINE CHART (Tendencia) ---
            if (chartTrend) chartTrend.dispose();
            chartTrend = echarts.init(document.getElementById('chartTrend'));
            chartTrend.setOption({
                tooltip: { trigger: 'axis' },
                grid: gridConfig,
                xAxis: { type: 'category', boundaryGap: false, data: data.evolucionGastos.labels },
                yAxis: { type: 'value' },
                series: [{
                    name: 'Monto',
                    type: 'line',
                    smooth: true,
                    lineStyle: { width: 3, color: '#4099ff' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(64, 153, 255, 0.5)' },
                            { offset: 1, color: 'rgba(64, 153, 255, 0.01)' }
                        ])
                    },
                    data: data.evolucionGastos.values
                }]
            });

            // --- B. PIE CHART (Donut) ---
            if (chartType) chartType.dispose();
            chartType = echarts.init(document.getElementById('chartType'));
            chartType.setOption({
                tooltip: { trigger: 'item' },
                legend: { bottom: 0, padding: 0, itemGap: 10 },
                series: [{
                    name: 'Distribución',
                    type: 'pie',
                    radius: ['35%', '65%'], // Donut responsivo
                    center: ['50%', '45%'], // Subimos un poco para dejar espacio a la leyenda
                    itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                    data: data.distribucionDinero,
                    color: ['#4099ff', '#FFB64D', '#2ed8b6']
                }]
            });

            // --- C. BAR CHART (Conceptos) ---
            if (chartConceptos) chartConceptos.dispose();
            chartConceptos = echarts.init(document.getElementById('chartConceptos'));
            chartConceptos.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: gridConfig,
                xAxis: { type: 'value' },
                yAxis: {
                    type: 'category',
                    data: data.gastosPorConcepto.labels,
                    axisLabel: {
                        interval: 0,
                        rotate: 0, // En móviles los nombres largos se ajustan gracias a containLabel
                        width: 100,
                        overflow: 'break' // Romper líneas si es muy largo
                    }
                },
                series: [{
                    name: 'Total',
                    type: 'bar',
                    barWidth: '60%',
                    data: data.gastosPorConcepto.values,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [
                            { offset: 0, color: '#2ed8b6' },
                            { offset: 1, color: '#59e0c5' }
                        ]),
                        borderRadius: [0, 5, 5, 0]
                    }
                }]
            });

            // --- D. BAR CHART (Estados) ---
            if (chartStatus) chartStatus.dispose();
            chartStatus = echarts.init(document.getElementById('chartStatus'));
            chartStatus.setOption({
                tooltip: { trigger: 'item' },
                grid: gridConfig,
                xAxis: { type: 'category', data: data.estadoLiquidaciones.labels },
                yAxis: { type: 'value' },
                series: [{
                    data: data.estadoLiquidaciones.values,
                    type: 'bar',
                    showBackground: true,
                    backgroundStyle: { color: 'rgba(180, 180, 180, 0.1)' },
                    itemStyle: {
                        color: function(params) {
                            const colors = ['#007bff', '#6c757d', '#28a745'];
                            return colors[params.dataIndex % colors.length];
                        },
                        borderRadius: [5, 5, 0, 0]
                    }
                }]
            });

            // =========================================================
            // LÓGICA DE RESPONSIVIDAD (RESIZE LISTENER)
            // =========================================================
            window.addEventListener('resize', function() {
                chartTrend && chartTrend.resize();
                chartType && chartType.resize();
                chartConceptos && chartConceptos.resize();
                chartStatus && chartStatus.resize();
            });
        }
    </script>
}