@model YnnovaComprobantes.ViewModels.EditarReembolsoViewModel
@{
    ViewData["Title"] = "Mis Sustentos - Reembolso #" + Model.Reembolso.Id;

    var nombreEmpresa = Model.Empresas.FirstOrDefault(x => x.Id == Model.Reembolso.EmpresaId)?.Nombre ?? "No definido";
    var nombreUsuario = Model.Usuarios.FirstOrDefault(x => x.Id == Model.Reembolso.UsuarioId)?.Nombre ?? "No definido";
    var nombreBanco = Model.Bancos.FirstOrDefault(x => x.Id == Model.Reembolso.BancoId)?.Descripcion ?? "No asignado";
    var nombreMoneda = Model.Monedas.FirstOrDefault(x => x.Id == Model.Reembolso.MonedaId)?.Simbolo ?? "-";
}

<style>
    .chat-box {
        max-height: 350px;
        overflow-y: auto;
        padding: 10px;
        background: #f4f6f9;
        border-radius: 5px;
    }

    .direct-chat-msg {
        margin-bottom: 10px;
    }

    .direct-chat-text {
        border-radius: .3rem;
        background: #d2d6de;
        border: 1px solid #d2d6de;
        color: #444;
        margin: 5px 0 0 50px;
        padding: 5px 10px;
        position: relative;
    }

    .right .direct-chat-text {
        background: #3b8bba;
        border-color: #3b8bba;
        color: #fff;
        margin-left: 0;
        margin-right: 50px;
    }

    .drag-over {
        background-color: #e8f0fe;
        border-color: #007bff !important;
    }

    .drop-zone {
        border: 2px dashed #ccc;
        transition: all 0.3s;
        cursor: pointer;
    }

    .form-control-plaintext-custom {
        background-color: #e9ecef;
        opacity: 1;
        border: 1px solid #ced4da;
    }
</style>

<div class="container-fluid pt-3">
    <div class="row">

        <div class="col-md-4">
            <div class="card card-info shadow-sm mb-3">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-eye"></i> Datos del Reembolso</h3>
                    <div class="card-tools">
                        <span class="badge badge-light">@Model.Estado?.Nombre</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-2">
                            <label>Empresa</label>
                            <input type="text" class="form-control form-control-sm form-control-plaintext-custom" value="@nombreEmpresa" readonly>
                        </div>
                        <div class="col-md-12 mb-2">
                            <label>Usuario Solicitante</label>
                            <input type="text" class="form-control form-control-sm form-control-plaintext-custom" value="@nombreUsuario" readonly>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label>Banco</label>
                            <input type="text" class="form-control form-control-sm form-control-plaintext-custom" value="@nombreBanco" readonly>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label>N° Cuenta</label>
                            <input type="text" class="form-control form-control-sm form-control-plaintext-custom" value="@Model.Reembolso.NumeroCuenta" readonly>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label>Moneda</label>
                            <input type="text" class="form-control form-control-sm form-control-plaintext-custom" value="@nombreMoneda" readonly>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label>Fecha Solicitud</label>
                            <input type="text" class="form-control form-control-sm form-control-plaintext-custom" value="@Model.Reembolso.FechaSolicitud?.ToString("yyyy-MM-dd")" readonly>
                        </div>
                        <div class="col-12 mb-2">
                            <label>Descripción</label>
                            <textarea class="form-control form-control-sm form-control-plaintext-custom" rows="2" readonly>@Model.Reembolso.Descripcion</textarea>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-right">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="fct_Volver()">
                        <i class="fas fa-arrow-left"></i> Volver al listado
                    </button>
                </div>
            </div>

            <div class="card card-warning shadow-sm">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-comments"></i> Observaciones</h3>
                </div>
                <div class="card-body p-0">
                    <div class="chat-box" id="div_ChatBox">
                        <div class="text-center text-muted mt-5">Cargando comentarios...</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group mb-2">
                        <select id="sel_Prioridad" class="form-control form-control-sm" style="max-width: 100px;">
                            <option value="B">Baja</option>
                            <option value="M">Media</option>
                            <option value="A">Alta</option>
                        </select>
                        <input type="text" id="txt_MensajeChat" placeholder="Responder..." class="form-control form-control-sm">
                        <span class="input-group-append">
                            <button type="button" class="btn btn-warning btn-sm" onclick="fct_EnviarObservacion()">Enviar</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card card-success shadow-sm mb-3">
                <div class="card-header collapsed-card" data-toggle="collapse" data-target="#collapseComprobante" style="cursor: pointer;">
                    <h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Registrar Nuevo Comprobante</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="collapse show" id="collapseComprobante">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label>RUC</label>
                                <input type="text" id="txt_Comp_RUC" class="form-control form-control-sm" maxlength="11">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label>Serie</label>
                                <input type="text" id="txt_Comp_Serie" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label>Número</label>
                                <input type="text" id="txt_Comp_Numero" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label>Tipo</label>
                                <select id="cbx_Comp_Tipo" class="form-control form-control-sm"></select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label>Concepto</label>
                                <select id="cbx_Comp_Concepto" class="form-control form-control-sm"></select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label>Moneda / Monto</label>
                                <div class="input-group input-group-sm">
                                    <select id="cbx_Comp_Moneda" class="form-control" style="max-width: 80px;"></select>
                                    <input type="number" id="txt_Comp_Monto" class="form-control" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label>Fecha Emisión</label>
                                <input type="date" id="txt_Comp_Fecha" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-8 mb-2">
                                <label>Adjunto (Imagen/PDF)</label>
                                <div id="dropZone" class="drop-zone text-center p-2 rounded bg-light">
                                    <p class="text-muted mb-1 small" id="lbl_DropInfo">Arrastra o click aquí</p>
                                    <input type="file" id="file_Comp_Archivo" class="d-none" accept=".jpg, .jpeg, .png, .pdf">
                                    <div id="previewArea" style="display:none;" class="d-flex align-items-center justify-content-center">
                                        <i id="icon_Preview" class="fas fa-file mr-2"></i>
                                        <span id="name_Preview" class="small font-weight-bold mr-2"></span>
                                        <button type="button" class="btn btn-xs btn-danger" id="btn_RemoveFile"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 text-right mt-2">
                                <button class="btn btn-success btn-sm" id="btn_RegistrarComprobante">
                                    <i class="fas fa-check"></i> Registrar Comprobante
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-secondary shadow-sm">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list"></i> Comprobantes Registrados</h3>
                </div>
                <div class="card-body">
                    <table id="tbl_ComprobantesDetalle" class="table table-bordered table-striped table-sm w-100">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Concepto</th>
                                <th>Monto</th>
                                <th>Archivo</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var reembolsoId = @Model.Reembolso.Id;
    var usuarioLogueadoId = @Model.UsuarioLogueadoId;
    var selMonedaId = @Model.Reembolso.MonedaId;

    $(document).ready(function () {
        cargarListasParaComprobante();
        initCardComprobante();
        initTableComprobantes();
        cargarObservaciones();
    });

    function cargarListasParaComprobante() {
        // Usamos las APIs del controlador de Reembolso
        cargarDropdown('/Reembolso/GetMonedasData', '#cbx_Comp_Moneda', selMonedaId);
        cargarDropdown('/Reembolso/GetTipoComprobanteData', '#cbx_Comp_Tipo', null);
        cargarDropdown('/Reembolso/GetConceptosData', '#cbx_Comp_Concepto', null);
    }

    function cargarDropdown(url, selector, valor) {
        let $select = $(selector);
        return $.getJSON(url, function(resp) {
            if(resp.status) {
                let html = '<option value="">-- Seleccionar --</option>';
                resp.data.forEach(item => {
                    let texto = item.nombre || item.descripcion;
                    html += `<option value="${item.id}">${texto}</option>`;
                });
                $select.html(html);
                if(valor) $select.val(valor);
            }
        });
    }
    
    function initCardComprobante() {
        const dropZone = $('#dropZone');
        const fileInput = $('#file_Comp_Archivo');

        // 1. Al hacer clic en la zona, disparamos el input FILE
        dropZone.on('click', function (e) {
            // Si el clic viene del botón de eliminar, no hacer nada aquí
            if ($(e.target).closest('#btn_RemoveFile').length) return;

            fileInput.trigger('click');
        });

        // 2. IMPORTANTE: Detener la propagación en el input para evitar el bucle infinito
        fileInput.on('click', function (e) {
            e.stopPropagation();
        });

        // 3. Cuando el archivo cambia
        fileInput.on('change', function () {
            if (this.files.length > 0) {
                mostrarPreview(this.files[0]);
            }
        });

        // 4. Drag & Drop
        dropZone.on('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).addClass('drag-over');
        });

        dropZone.on('dragleave', function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('drag-over');
        });

        dropZone.on('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('drag-over');

            let files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                fileInput[0].files = files; // Asignar archivos al input
                mostrarPreview(files[0]);
            }
        });

        // 5. Botón de remover
        $('#btn_RemoveFile').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation(); // Evitar que abra el selector de archivos al borrar
            fileInput.val('');
            $('#previewArea').hide();
            $('#lbl_DropInfo').show();
        });

        function mostrarPreview(file) {
            $('#lbl_DropInfo').hide();
            $('#name_Preview').text(file.name);
            $('#previewArea').show();
            let icon = file.type.includes('pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-primary';
            $('#icon_Preview').attr('class', 'fas ' + icon + ' fa-2x');
        }

        // 5. REGISTRAR COMPROBANTE (AJAX)
        $('#btn_RegistrarComprobante').off('click').on('click', function() {
            // Validaciones simples
            if(!$('#txt_Comp_Monto').val() || !$('#txt_Comp_Fecha').val()) {
                toastr.warning("Complete el monto y la fecha."); return;
            }
            let file = $('#file_Comp_Archivo')[0].files[0];
            if(!file) {
                toastr.warning("Debes adjuntar el archivo (foto o pdf)."); return;
            }

            let formData = new FormData();
            formData.append("ReembolsoId", reembolsoId);
            formData.append("UsuarioId", @Model.Reembolso.UsuarioId);
            formData.append("RucEmpresa", $('#txt_Comp_RUC').val());
            formData.append("Serie", $('#txt_Comp_Serie').val());
            formData.append("Numero", $('#txt_Comp_Numero').val());
            formData.append("TipoComprobanteId", $('#cbx_Comp_Tipo').val());
            formData.append("ConceptoId", $('#cbx_Comp_Concepto').val());
            formData.append("MonedaId", $('#cbx_Comp_Moneda').val());
            formData.append("MontoTotal", $('#txt_Comp_Monto').val());
            formData.append("FechaEmision", $('#txt_Comp_Fecha').val());
            formData.append("ArchivoComprobante", file);

            Swal.fire(
                {
                    title: '¿Registrar comprobante?',
                    text: "Esta acción registrará al comprobante.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, registrar comprobante",
                    cancelButtonText: "Cancelar",
                    reverseButtons: true
                }).then((r) => {
                if(r.isConfirmed) {
                    $.ajax({
                        url: "/Reembolso/RegistrarComprobante",
                        type: "POST",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function(resp) {
                            if(resp.status) {
                                toastr.success(resp.message);
                                limpiarForm();
                                $('#tbl_ComprobantesDetalle').DataTable().ajax.reload();
                            } else {
                                toastr.error(resp.message);
                            }
                        },
                        error: function() {
                            toastr.error("Error al subir el archivo.");
                        }
                    });
                }
            });
        });
    }

    function limpiarForm() {
        $('#txt_Comp_RUC, #txt_Comp_Serie, #txt_Comp_Numero, #txt_Comp_Monto').val('');
        $('#btn_RemoveFile').click();
    }

    function initTableComprobantes() {
        $('#tbl_ComprobantesDetalle').DataTable({
            paging: true,
            select: true,
            scroller: false,
            deferRender: true,
            scrollY: true,
            scrollX: true,
            fixedHeader: true,
            ordering: true,
            destroy: true,
            responsive: true,
            autoWidth: false,
            processing: true,
            filter: true,
            orderMulti: true,
            stateSave: false,
            serverSide: false,
            language: {
                processing: "Procesando...",
                sSearch: "Buscar:",
                lengthMenu: "Mostrar _MENU_ registros",
                info: "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                infoEmpty: "Sin registros encontrados.",
                infoFiltered: "(Total de _MAX_ registros filtrados)",
                loadingRecords: "Cargando...",
                zeroRecords: "No se encontraron registros",
                emptyTable: "No hay datos disponibles en la tabla",
                paginate: {
                    previous: "Anterior",
                    next: "Siguiente",
                    first: "Primero",
                    last: "Último",
                },
                aria: {
                    sortAscending: ": Activar para ordenar la columna de manera ascendente",
                    sortDescending: ": Activar para ordenar la columna de manera descendente"
                },
                select: {
                    rows: {
                        _: "%d filas seleccionadas",
                        0: "Haz clic en una fila para seleccionarla",
                        1: "1 fila seleccionada"
                    }
                },
                buttons: {
                    copyTitle: 'Copiado en el portapapeles',
                    copyKeys: 'Presiona <i>ctrl</i> o <i>\u2318</i> + <i>C</i> para copiar los datos de la tabla a tu portapapeles. <br><br>Para cancelar, haga clic en este mensaje o presione Esc.',
                    copySuccess: {
                        _: '%d registros copiados correctamente',
                        1: '1 registro copiado correctamente'
                    }
                }
            },
            lengthMenu: [[100, 200, 500, -1], [100, 200, 500, 'Todos']],
            responsive: true,
            ajax: { url: '/Reembolso/GetComprobantesPorReembolso?reembolsoId=' + reembolsoId, type: 'GET', dataSrc: 'data' },
            columns: [
                { data: 'fechaEmision', render: d => moment(d).format('DD/MM/YYYY') },
                { data: 'proveedorNombre', render: (d,t,r) => `<div>${r.rucEmpresa}</div><small>${r.serie}-${r.numero}</small>` },
                { data: 'concepto' },
                { data: 'montoTotal', render: d => parseFloat(d).toFixed(2) },
                { data: 'archivoUrl', render: d => d ? `<a href="${d}" target="_blank" class="btn btn-xs btn-info"><i class="fas fa-eye"></i></a>` : '-' },
                { data: 'estadoNombre', render: d => `<span class="badge badge-info">${d}</span>` },
                {
                    data: 'id',
                    render: (id, t, row) => {
                        if (row.estadoNombre === 'Pendiente' || row.estadoNombre === 'Observado') {
                            return `<button class="btn btn-xs btn-danger" onclick="eliminarComprobante(${id})"><i class="fas fa-trash"></i></button>`;
                        }
                        return '<i class="fas fa-lock text-muted"></i>';
                    }
                }
            ],
            columnDefs: [
                { targets: '_all', className: 'align-middle' },
                { targets: [4, 5, 6], className: 'text-center' },
            ]
        });
    }

    function eliminarComprobante(id) {
        Swal.fire({
            title: '¿Eliminar?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sí, eliminar comprobante",
            cancelButtonText: "Cancelar",
            reverseButtons: true
        }).then((r) => {
            if(r.isConfirmed) {
                $.post('/Reembolso/EliminarComprobante', { id: id }, () => $('#tbl_ComprobantesDetalle').DataTable().ajax.reload());
            }
        });
    }

    function cargarObservaciones() {
        $.getJSON('/Reembolso/GetObservaciones?reembolsoId=' + reembolsoId, function(resp) {
            let html = '';
            resp.data.forEach(obs => {
                let esMio = obs.usuarioId === usuarioLogueadoId;
                let alineacion = esMio ? 'right' : 'left';
                html += `<div class="direct-chat-msg ${alineacion}"><div class="direct-chat-infos clearfix"><span class="direct-chat-name float-${alineacion}">${esMio ? 'Yo' : obs.nombreUsuario}</span></div><div class="direct-chat-text">${obs.mensaje}</div></div>`;
            });
            $('#div_ChatBox').html(html).scrollTop($('#div_ChatBox')[0].scrollHeight);
        });
    }

    function fct_EnviarObservacion() {
        let msg = $('#txt_MensajeChat').val();
        if(!msg.trim()) return;
        $.post('/Reembolso/RegistrarObservacion', { ReembolsoId: reembolsoId, Mensaje: msg, Prioridad: $('#sel_Prioridad').val() }, function() {
            $('#txt_MensajeChat').val('');
            cargarObservaciones();
        });
    }

    function fct_Volver() { window.location.href = '/Reembolso'; }
</script>